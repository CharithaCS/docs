<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-quick-tutorials/k8s-kafka-mtls">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Automate secure Kafka access | Otterize</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.otterize.com/quick-tutorials/k8s-kafka-mtls"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Automate secure Kafka access | Otterize"><meta data-rh="true" name="description" content="This tutorial will walk you through declaring and applying intents to easily secure access to Kafka,"><meta data-rh="true" property="og:description" content="This tutorial will walk you through declaring and applying intents to easily secure access to Kafka,"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://docs.otterize.com/quick-tutorials/k8s-kafka-mtls"><link data-rh="true" rel="alternate" href="https://docs.otterize.com/quick-tutorials/k8s-kafka-mtls" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.otterize.com/quick-tutorials/k8s-kafka-mtls" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://69PZ47MO2R-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Otterize" href="/opensearch.xml">

<script>!function(t,h,e,j,s,n){t.hj=t.hj||function(){(t.hj.q=t.hj.q||[]).push(arguments)},t._hjSettings={hjid:3152141,hjsv:6},s=h.getElementsByTagName("head")[0],(n=h.createElement("script")).async=1,n.src="https://static.hotjar.com/c/hotjar-"+t._hjSettings.hjid+".js?sv="+t._hjSettings.hjsv,s.appendChild(n)}(window,document)</script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2EG876ZREF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2EG876ZREF",{})</script><link rel="stylesheet" href="/assets/css/styles.3892af1d.css">
<link rel="preload" href="/assets/js/runtime~main.df3032c7.js" as="script">
<link rel="preload" href="/assets/js/main.bfbfb966.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://otterize.com" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/otterize-logo-dark.svg" alt="Otterize" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/otterize-logo-light.svg" alt="Otterize" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://otterize.com/open-source" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link">Open source<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://otterize.com/product" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link">Product<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://otterize.com/ibac" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link">IBAC<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Docs</a><a href="https://otterize.com/pricing" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link">Pricing<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://otterize.com/team" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link">Team<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://otterize.com/blog" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/otterize" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" class="navbar_external_logo_first"><img src="/img/github-round-logo.svg"></a><a href="https://joinslack.otterize.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" class="navbar_external_logo"><img src="/img/slack-logo-no-border.svg"></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Getting started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/quick-tutorials/">Quick tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Quick tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/quick-tutorials/k8s-network-policies">Automate network policies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/quick-tutorials/k8s-network-mapper">Map your cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/quick-tutorials/k8s-kafka-mtls">Automate secure Kafka access</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/quick-tutorials/k8s-mtls">Deploy mTLS between pods</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/k8s-installation/">Installing Otterize in Kubernetes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/guides/">Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/terminology/">Terminology</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/intent-based-access-control/">IBAC: Intent-based access control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/intents-and-intents-files/">Intents and intents files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/otterize-oss/">Otterize OSS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/service-identities/">Service identities and resolution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/k8s-mtls/">Kubernetes mTLS with Otterize</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cli/">CLI command reference</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/components/otterize-chart/">Components</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/security/">Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/faq/">FAQ</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/quick-tutorials/"><span itemprop="name">Quick tutorials</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Automate secure Kafka access</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Automate secure Kafka access</h1></header><p>This tutorial will walk you through declaring and applying intents to easily secure access to Kafka,
automating the generation and deployment of certificates for mTLS and the configuration of ACLs for Kafka.</p><p>In this tutorial, we will:</p><ul><li>Deploy a Kafka broker, and two clients that call it.</li><li>Declare that one client pod intends to access a topic on Kafka.</li><li>See that an ACL was autogenerated to allow just that, while blocking calls from the other client.</li><li>See that mTLS credentials were autogenerated.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-otterize">Install Otterize<a class="hash-link" href="#install-otterize" title="Direct link to heading">​</a></h2><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>For this tutorial, we&#x27;ll disable the network policy component, to focus on the Kafka ACL authorization mechanism.
If you already have Otterize installed, redeploy it as shown below. You can always re-enable the network policy component
later by deploying it as shown below but without the <code>--set</code> flag.</p></div></div><p>Use Helm to install the latest version of Otterize:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo </span><span class="token function" style="color:#79b6f2">add</span><span class="token plain"> otterize https://helm.otterize.com</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">helm </span><span class="token function" style="color:#79b6f2">install</span><span class="token plain"> -n otterize-system --create-namespace </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--set intentsOperator.operator.enableNetworkPolicyCreation</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">false otterize otterize/otterize-kubernetes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can add the <code>--wait</code> flag for Helm to wait for deployment to complete and all pods to be Ready, or manually watch for all pods to be <code>Ready</code> using <code>kubectl get pods -n otterize-system -w</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-kafka">Install Kafka<a class="hash-link" href="#install-kafka" title="Direct link to heading">​</a></h2><p>We will deploy a Kafka cluster using Bitnami&#x27;s <a href="https://github.com/bitnami/charts/tree/master/bitnami/kafka" target="_blank" rel="noopener noreferrer">Helm chart</a>.
In the chart we will configure Kafka to:</p><ul><li>Recognize the Otterize intents operator as a super user so it can configure ACLs;</li><li>Use TLS (Kafka calls it SSL) for its listeners;</li><li>Tell the Otterize SPIRE integration operator, via pod annotations, how credentials should be created; and</li><li>Authenticate clients using mTLS credentials provided as a Kubernetes secret</li></ul><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand to see the Helm values.yaml used with the Bitnami chart</summary><div><div class="collapsibleContent_i85q"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token comment" style="color:#999999"># Configure Otterize as a super user to grant it access to configure ACLs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">superUsers</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;User:CN=kafka.kafka,O=SPIRE,C=US;User:CN=intents-operator-controller-manager.otterize,O=SPIRE,C=US&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999"># Use TLS for the Kafka listeners (Kafka calls them SSL)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">listeners</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;CLIENT://:9092&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;INTERNAL://:9093&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">advertisedListeners</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;CLIENT://:9092&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;INTERNAL://:9093&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">listenerSecurityProtocolMap</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;INTERNAL:SSL,CLIENT:SSL&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999"># Annotations for Otterize to generate credentials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">podAnnotations</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">spire-integration.otterize.com/cert-type</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> jks</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">spire-integration.otterize.com/tls-secret-name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">tls</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">spire-integration.otterize.com/truststore-file-name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka.truststore.jks</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">spire-integration.otterize.com/keystore-file-name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">keystore.jks</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">spire-integration.otterize.com/dns-names</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;kafka-0.kafka-headless.kafka.svc.cluster.local,kafka.kafka.svc.cluster.local&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999"># Authenticate clients using mTLS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">auth</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">clientProtocol</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> mtls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">interBrokerProtocol</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> mtls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">tls</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">type</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> jks</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">existingSecrets</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">tls</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">password</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> password</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">authorizerClassName</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka.security.authorizer.AclAuthorizer</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999"># Allocate resources</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">resources</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">requests</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">cpu</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> 50m</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">memory</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> 256Mi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>The following command will deploy a Kafka cluster with this chart:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo </span><span class="token function" style="color:#79b6f2">add</span><span class="token plain"> bitnami https://charts.bitnami.com/bitnami</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">helm </span><span class="token function" style="color:#79b6f2">install</span><span class="token plain"> --create-namespace -n kafka </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --version </span><span class="token number" style="color:#5a9bcf">14</span><span class="token plain">.x.x </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  -f https://docs.otterize.com/code-examples/kafka-mtls/helm/values.yaml kafka bitnami/kafka</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can watch for all pods to be <code>Ready</code> using <code>kubectl get pods -n kafka -w</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="manage-kafka-access-with-otterize">Manage Kafka access with Otterize<a class="hash-link" href="#manage-kafka-access-with-otterize" title="Direct link to heading">​</a></h2><p>Let&#x27;s connect Kafka with Otterize by applying a <code>KafkaServerConfig</code>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f https://docs.otterize.com/code-examples/kafka-mtls/kafkaserverconfig.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand to see the KafkaServerConfig</summary><div><div class="collapsibleContent_i85q"><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">kafkaserverconfig.yaml</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> k8s.otterize.com/v1alpha1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> KafkaServerConfig</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafkaserverconfig</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">spec</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">service</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">addr</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka.kafka</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token number" style="color:#5a9bcf">9092</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">tls</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">certFile</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /etc/otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">spire/svid.pem</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">keyFile</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /etc/otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">spire/key.pem</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">rootCAFile</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /etc/otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">spire/bundle.pem</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">topics</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">topic</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">pattern</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> prefix</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">clientIdentityRequired</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#ff8b50;font-weight:400">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">intentsRequired</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#ff8b50;font-weight:400">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div></div></div></details><p>Upon applying the KafkaServerConfig, an ACL will configure Kafka to allow anonymous access all topics.
This will be the base state, from which we will gradually roll out secure access to Kafka.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl logs -n kafka statefulset/kafka </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">grep</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;Processing Acl change&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">grep</span><span class="token plain"> ANONYMOUS </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">tail</span><span class="token plain"> -n </span><span class="token number" style="color:#5a9bcf">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see the following output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">[2022-09-13 10:58:32,052] INFO Processing Acl change notification for</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">ResourcePattern(resourceType=TOPIC, name=*, patternType=PREFIXED), versionedAcls :</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Set(User:ANONYMOUS has ALLOW permission for operations: ALL from hosts: *,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">User:* has ALLOW permission for operations: ALL from hosts: *), zkVersion : 0</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">(kafka.security.authorizer.AclAuthorizer)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-clients">Deploy clients<a class="hash-link" href="#deploy-clients" title="Direct link to heading">​</a></h2><p>Clients will authenticate to Kafka using mTLS. Otterize makes this easy, requiring just 3 simple changes to the client pod spec:</p><ol><li><strong>Generate credentials</strong>: add the <code>otterize/tls-secret-name</code> annotation, which tells Otterize to generate mTLS credentials and store them in a Kubernetes secret whose name is the value of this annotation.</li><li><strong>Expose credentials in a volume</strong>: add a volume containing this secret to the pod.</li><li><strong>Mount the volume</strong>: mount the volume in every container in the pod.</li></ol><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand to see this structure</summary><div><div class="collapsibleContent_i85q"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">spec</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">template</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">annotations</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">        </span><span class="token comment" style="color:#999999"># 1. Generate credentials as a secret called &quot;client-credentials-secret&quot;:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">otterize/tls-secret-name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> client</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">spec</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">volumes</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">        </span><span class="token comment" style="color:#999999"># 2. Create a volume containing this secret:</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">secret</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">secretName</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> client</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">containers</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> client</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">volumeMounts</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">            </span><span class="token comment" style="color:#999999"># 3. Mount volume into container</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">mountPath</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /var/otterize/credentials</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">readOnly</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#ff8b50;font-weight:400">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>Our simple example consists of a two client pods <!-- -->—<!-- --> &quot;client&quot; and &quot;client-other&quot; <!-- -->—<!-- --> and the Kafka broker.</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand to see the client specs used in this example</summary><div><div class="collapsibleContent_i85q"><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">namespace.yaml</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">client-deployment.yaml</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">client-configmap.yaml</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">client-other-deployment.yaml</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">client-other-configmap.yaml</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">tutorial</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">mtls</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">tutorial</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">mtls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">spec</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">selector</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">matchLabels</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">app</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">template</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">labels</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">app</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">annotations</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">spire-integration.otterize.com/tls-secret-name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">spec</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">containers</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">image</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> golang</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">command</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;-c&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;--&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">args</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;while true; do cd /app; cp src/* .; go get main; go run .; sleep infinity; done&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">volumeMounts</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ephemeral</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">mountPath</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /app</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">mountPath</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /app/src</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">go</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">mountPath</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /var/otterize/credentials</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">readOnly</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#ff8b50;font-weight:400">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">volumes</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">go</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">configMap</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">go</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">secret</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">secretName</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ephemeral</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">emptyDir</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">go</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">tutorial</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">mtls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">data</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">myclient.go</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">|</span><span class="token scalar string" style="color:#8dc891"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token scalar string" style="color:#8dc891">    package main</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    import (</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;crypto/tls&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;crypto/x509&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;fmt&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;github.com/Shopify/sarama&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;github.com/sirupsen/logrus&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;io/ioutil&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;time&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    const (</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        kafkaAddr = &quot;kafka.kafka</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain">9092&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        testTopicName = &quot;mytopic&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        certFile = &quot;/var/otterize/credentials/svid.pem&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        keyFile = &quot;/var/otterize/credentials/key.pem&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        rootCAFile = &quot;/var/otterize/credentials/bundle.pem&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    func getTLSConfig()( * tls.Config</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> error) </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        cert</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = tls.LoadX509KeyPair(certFile</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> keyFile)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return nil</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">fmt.Errorf(&quot;failed loading x509 key pair</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> %w&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> err)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">pool</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = x509.NewCertPool()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        rootCAPEM</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = ioutil.ReadFile(rootCAFile)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return nil</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">fmt.Errorf(&quot;failed loading root CA PEM file</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> %w &quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> err)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        pool.AppendCertsFromPEM(rootCAPEM)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        return </span><span class="token important" style="font-weight:400">&amp;tls.Config</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">Certificates</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> tls.Certificate </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                cert</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">RootCAs</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> nil</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    func send_messages(producer sarama.SyncProducer) </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">i</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = 1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        for </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">msg</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = fmt.Sprintf(&quot;Message %d </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">sent by client</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain">&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> i)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            _</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            _</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = producer.SendMessage( &amp; sarama.ProducerMessage </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token key atrule" style="color:#FAC863">Topic</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> testTopicName</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token key atrule" style="color:#FAC863">Partition</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">-1</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token key atrule" style="color:#FAC863">Value</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> sarama.StringEncoder(msg)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                return</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            fmt.Printf(&quot;Sent message </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> %s\n&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> msg)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            time.Sleep(2 * time.Second)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            i++</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    func loop_kafka() error </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">addrs</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> string </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            kafkaAddr</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">config</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = sarama.NewConfig()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        fmt.Println(&quot;Loading mTLS certificates&quot;)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.TLS.Enable = true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        tlsConfig</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = getTLSConfig()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.TLS.Config = tlsConfig</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        fmt.Println(&quot;Connecting to Kafka&quot;)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.DialTimeout = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.ReadTimeout = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.WriteTimeout = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = sarama.NewClient(addrs</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> config)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        fmt.Println(&quot;Creating a producer and a consumer for </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> testTopicName)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Producer.Return.Successes = true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Producer.Timeout = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Consumer.MaxWaitTime = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Producer.Return.Errors = true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Consumer.Return.Errors = true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        producer</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = sarama.NewSyncProducerFromClient(client)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        consumer</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = sarama.NewConsumerFromClient(client)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        fmt.Println(&quot;Sending messages&quot;)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        go send_messages(producer)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        partConsumer</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = consumer.ConsumePartition(testTopicName</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> 0)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">for msg</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = range partConsumer.Messages() </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            fmt.Printf(&quot;Read message </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> %s\n&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> msg.Value)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        return nil</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    func main() </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        for </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = loop_kafka()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            logrus.WithError(err).Println()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            fmt.Println(&quot;Loop exited&quot;)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            time.Sleep(2 * time.Second)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">tutorial</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">mtls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">spec</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">selector</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">matchLabels</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">app</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">template</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">labels</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">app</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">annotations</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">spire-integration.otterize.com/tls-secret-name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">spec</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">containers</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">image</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> golang</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">command</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;/bin/sh&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;-c&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;--&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">args</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;while true; do cd /app; cp src/* .; go get main; go run .; sleep infinity; done&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">volumeMounts</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ephemeral</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">mountPath</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /app</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">mountPath</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /app/src</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">go</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">mountPath</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> /var/otterize/credentials</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">              </span><span class="token key atrule" style="color:#FAC863">readOnly</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#ff8b50;font-weight:400">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">volumes</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">go</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">configMap</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">go</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">secret</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">secretName</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">credentials</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ephemeral</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">emptyDir</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">go</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">tutorial</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">mtls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">data</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">myclient-other.go</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">|</span><span class="token scalar string" style="color:#8dc891"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token scalar string" style="color:#8dc891">    package main</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    import (</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;crypto/tls&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;crypto/x509&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;fmt&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;github.com/Shopify/sarama&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;github.com/sirupsen/logrus&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;io/ioutil&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;time&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    const (</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        kafkaAddr = &quot;kafka.kafka</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain">9092&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        testTopicName = &quot;mytopic&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        certFile = &quot;/var/otterize/credentials/svid.pem&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        keyFile = &quot;/var/otterize/credentials/key.pem&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        rootCAFile = &quot;/var/otterize/credentials/bundle.pem&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    func getTLSConfig()( * tls.Config</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> error) </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        cert</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = tls.LoadX509KeyPair(certFile</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> keyFile)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return nil</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">fmt.Errorf(&quot;failed loading x509 key pair</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> %w&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> err)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">pool</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = x509.NewCertPool()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        rootCAPEM</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = ioutil.ReadFile(rootCAFile)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return nil</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">fmt.Errorf(&quot;failed loading root CA PEM file</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> %w &quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> err)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        pool.AppendCertsFromPEM(rootCAPEM)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        return </span><span class="token important" style="font-weight:400">&amp;tls.Config</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">Certificates</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> tls.Certificate </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                cert</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">RootCAs</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> pool</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> nil</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    func loop_kafka() error </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">addrs</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"> string </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            kafkaAddr</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">config</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = sarama.NewConfig()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        fmt.Println(&quot;Loading mTLS certificates&quot;)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.TLS.Enable = true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        tlsConfig</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = getTLSConfig()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.TLS.Config = tlsConfig</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        fmt.Println(&quot;Connecting to Kafka&quot;)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.DialTimeout = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.ReadTimeout = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Net.WriteTimeout = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        client</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = sarama.NewClient(addrs</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> config)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        fmt.Println(&quot;Creating a producer for </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> testTopicName)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Producer.Return.Successes = true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Producer.Timeout = 5 * time.Second</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        config.Producer.Return.Errors = true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        producer</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = sarama.NewSyncProducerFromClient(client)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        fmt.Println(&quot;Sending messages&quot;)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token key atrule" style="color:#FAC863">i</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = 1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        for </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">msg</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = fmt.Sprintf(&quot;Message %d </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">sent by client</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">other</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain">&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> i)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            _</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            _</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            err = producer.SendMessage( &amp; sarama.ProducerMessage </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token key atrule" style="color:#FAC863">Topic</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> testTopicName</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token key atrule" style="color:#FAC863">Partition</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">-1</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token key atrule" style="color:#FAC863">Value</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> sarama.StringEncoder(msg)</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            if err </span><span class="token tag" style="color:#fc929e">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                return err</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            fmt.Printf(&quot;Sent message </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> %s\n&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> msg)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            time.Sleep(1 * time.Second)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            i++</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        return nil</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    func main() </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        for </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token key atrule" style="color:#FAC863">err</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> = loop_kafka()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            logrus.WithError(err).Println()</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            fmt.Println(&quot;Loop exited&quot;)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            time.Sleep(2 * time.Second)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div></div></div></details><ol><li><p>Deploy the two clients into a namespace called <code>otterize-tutorial-kafka-mtls</code> using <code>kubectl</code>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f https://docs.otterize.com/code-examples/kafka-mtls/all.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Optional: check deployment status</summary><div><div class="collapsibleContent_i85q"><p>Check that the client pods were deployed:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl get pods -n otterize-tutorial-kafka-mtls</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">NAME                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">myclient-5d9646fc46-tw5hs         1/1     Running   0          21s</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">myclient-other-59647b448c-w4cpq   1/1     Running   0          21s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>Let&#x27;s monitor, in separate terminal windows, both clients&#x27; attempts to call Kafka,
so we can see the effects of our changes in real time.</p></li><li><p><strong>Open a new terminal window <!-- -->[myclient]</strong> and tail the client log:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl logs -f --tail </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> -n otterize-tutorial-kafka-mtls deploy/myclient</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This client should be able to communicate with the server:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">Loading mTLS certificates</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Connecting to Kafka</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Creating a producer and a consumer for - mytopic</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sending messages</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 1 [sent by client]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Read message - Message 1 [sent by client]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Read message - Message 1 [sent by client-other]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 2 [sent by client]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Read message - Message 2 [sent by client-other]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Read message - Message 2 [sent by client]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Read message - Message 3 [sent by client-other]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 3 [sent by client]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Read message - Message 3 [sent by client]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>Open another terminal window <!-- -->[myclient-other]</strong> and tail the client-other log:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl logs -f --tail </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> -n otterize-tutorial-kafka-mtls deploy/myclient-other</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This other client should also be able to communicate with the server:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">Loading mTLS certificates</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Connecting to Kafka</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Creating a producer for - mytopic</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sending messages</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 1 [sent by client-other]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 2 [sent by client-other]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 3 [sent by client-other]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="apply-intents">Apply intents<a class="hash-link" href="#apply-intents" title="Direct link to heading">​</a></h2><ol><li>The client declares its intent to call the server with this <code>intents.yaml</code> file:</li></ol><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> k8s.otterize.com/v1alpha1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ClientIntents</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain">  otterize</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">tutorial</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">kafka</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">mtls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">spec</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">service</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> myclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">calls</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">type</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> kafka</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token key atrule" style="color:#FAC863">topics</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> mytopic</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token key atrule" style="color:#FAC863">operation</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>Client intents are the cornerstone of <a href="https://otterize.com/ibac" target="_blank" rel="noopener noreferrer">intent-based access control</a>.</p></div></div><ol start="2"><li><p>Keep an eye on the logs being tailed in the <strong>[client-other]</strong> while you apply this <code>intents.yaml</code> file in your <strong>main terminal window</strong> using:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f https://docs.otterize.com/code-examples/kafka-mtls/client-intents.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should quickly see in the <strong>[client-other]</strong> that the <strong>other client cannot</strong> access the topic:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 12 [sent by client-other]            # &lt;- before applying the intents file</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 13 [sent by client-other]            # &lt;- before applying the intents file</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">time=&quot;2022-10-06T09:44:53Z&quot; level=info error=&quot;kafka server: # &lt;- after applying the intents file</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  The client is not authorized to access this topic&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Loop exited</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Meanwhile, in the <strong>[client]</strong> terminal you can see that the <strong>client can</strong> access the topic:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 24 [sent by client]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Read message - Message 24 [sent by client]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Sent message - Message 25 [sent by client]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Read message - Message 25 [sent by client]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Verify that an ACL for this client was configured on the Kafka broker:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl logs -n kafka statefulset/kafka </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">grep</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;Processing Acl change&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">grep</span><span class="token plain"> mytopic </span><span class="token operator" style="color:#d7deea">|</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">tail</span><span class="token plain"> -n </span><span class="token number" style="color:#5a9bcf">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">[2022-09-13 10:44:52,803] INFO Processing Acl change notification for</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">ResourcePattern(resourceType=TOPIC, name=mytopic, patternType=LITERAL), </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">versionedAcls : Set(User:ANONYMOUS has DENY permission for operations: </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">ALL from hosts: *, User:CN=myclient.otterize-tutorial-kafka-mtls,O=SPIRE,C=US has ALLOW permission</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">for operations: ALL from hosts: *), zkVersion : 6 (kafka.security.authorizer.AclAuthorizer)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-did-we-accomplish">What did we accomplish?<a class="hash-link" href="#what-did-we-accomplish" title="Direct link to heading">​</a></h2><ul><li><p>Controlling Kafka access no longer means touching ACLs, issuing and managing and distributing certs, establishing trust,
etc.</p></li><li><p>As we saw with pod-to-pod access, clients simply declare with their intents files the Kafka access they need,
and define a place on their filesystem where they&#x27;ll get the appropriate credentials (certs).</p></li><li><p>The next <code>kubectl apply</code> ensures that all the appropriate certs are issued and distributed,
and that Kafka ACLs are configured to reflect precisely the intended topic-level access.</p></li></ul><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand to see what happened behind the scenes</summary><div><div class="collapsibleContent_i85q"><p>We configured the Kafka helm chart to:</p><ul><li>Use the SSL protocol for its listeners</li><li>Let Otterize know it should generate mTLS credentials in the Java Key Store and Java Trust Store format and store them as a K8s secret.</li><li>Use the K8s secret for its credentials.</li></ul><p>We configured out clients to</p><ul><li>Let Otterize know it should generate mTLS credentials in a PEM format.</li><li>Use the K8s secret for its credentials.</li></ul><p>By this point we had an mTLS between both clients and Kafka.</p><p>Then we applied intents:</p><ul><li>To allow only intended access from the <em>client</em> pod.</li></ul></div></div></details><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Bonus tutorial</div><div class="admonitionContent_S0QG"><p>Try to create an intents file yourself for <strong>client-other</strong>, and apply it to allow this other client to access the topic.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next">What&#x27;s next<a class="hash-link" href="#whats-next" title="Direct link to heading">​</a></h2><ul><li>Explore how to gradually rollout <a href="/guides/ibac-for-k8s-kafka/">secure access for Kafka</a> on your existing infrastructure.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="teardown">Teardown<a class="hash-link" href="#teardown" title="Direct link to heading">​</a></h2><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>Take care to remove the intents before removing the KafkaServerConfig or the Kafka broker, as the operator will not know how to remove
the intents if you first make it forget about the Kafka broker or it can&#x27;t access the broker.
If it&#x27;s unable to remove the ACLs for the intents, the operator will prevent the intents from being deleted until
it is able to do so.</p></div></div><p>To remove the deployed examples run:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token comment" style="color:#999999"># run this first:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl delete -f https://docs.otterize.com/code-examples/kafka-mtls/client-intents.yaml</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999"># then the rest:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl delete -f https://docs.otterize.com/code-examples/kafka-mtls/all.yaml</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl delete -f https://docs.otterize.com/code-examples/kafka-mtls/kafkaserverconfig.yaml</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">helm uninstall kafka -n kafka</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/otterize/docs/edit/main/docs/quick-tutorials/k8s-kafka-mtls.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/quick-tutorials/k8s-network-mapper"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Map your cluster</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/quick-tutorials/k8s-mtls"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deploy mTLS between pods</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#install-otterize" class="table-of-contents__link toc-highlight">Install Otterize</a></li><li><a href="#install-kafka" class="table-of-contents__link toc-highlight">Install Kafka</a></li><li><a href="#manage-kafka-access-with-otterize" class="table-of-contents__link toc-highlight">Manage Kafka access with Otterize</a></li><li><a href="#deploy-clients" class="table-of-contents__link toc-highlight">Deploy clients</a></li><li><a href="#apply-intents" class="table-of-contents__link toc-highlight">Apply intents</a></li><li><a href="#what-did-we-accomplish" class="table-of-contents__link toc-highlight">What did we accomplish?</a></li><li><a href="#whats-next" class="table-of-contents__link toc-highlight">What&#39;s next</a></li><li><a href="#teardown" class="table-of-contents__link toc-highlight">Teardown</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/quick-tutorials/...">Join us on Slack</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://otterize.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Otterize</a></li><li class="footer__item"><a href="https://otterize.com/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li><li class="footer__item"><a href="https://github.com/otterize" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with Docusaurus</div></div></div></footer></div>
<script src="/assets/js/runtime~main.df3032c7.js"></script>
<script src="/assets/js/main.bfbfb966.js"></script>
</body>
</html>