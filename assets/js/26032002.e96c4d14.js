"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5750],{5162:(e,t,n)=>{n.d(t,{Z:()=>r});var a=n(7294),o=n(6010);const l="tabItem_Ymn6";function r(e){let{children:t,hidden:n,className:r}=e;return a.createElement("div",{role:"tabpanel",className:(0,o.Z)(l,r),hidden:n},t)}},5488:(e,t,n)=>{n.d(t,{Z:()=>m});var a=n(7462),o=n(7294),l=n(6010),r=n(2389),i=n(7392),s=n(7094),c=n(2466);const p="tabList__CuJ",d="tabItem_LNqP";function u(e){var t,n;const{lazy:r,block:u,defaultValue:m,values:h,groupId:k,className:g}=e,w=o.Children.map(e.children,(e=>{if((0,o.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),v=null!=h?h:w.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),f=(0,i.l)(v,((e,t)=>e.value===t.value));if(f.length>0)throw new Error('Docusaurus error: Duplicate values "'+f.map((e=>e.value)).join(", ")+'" found in <Tabs>. Every value needs to be unique.');const y=null===m?m:null!=(t=null!=m?m:null==(n=w.find((e=>e.props.default)))?void 0:n.props.value)?t:w[0].props.value;if(null!==y&&!v.some((e=>e.value===y)))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+y+'" but none of its children has the corresponding value. Available values are: '+v.map((e=>e.value)).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");const{tabGroupChoices:b,setTabGroupChoices:N}=(0,s.U)(),[C,T]=(0,o.useState)(y),z=[],{blockElementScrollPositionUntilNextRender:I}=(0,c.o5)();if(null!=k){const e=b[k];null!=e&&e!==C&&v.some((t=>t.value===e))&&T(e)}const A=e=>{const t=e.currentTarget,n=z.indexOf(t),a=v[n].value;a!==C&&(I(t),T(a),null!=k&&N(k,String(a)))},S=e=>{var t;let n=null;switch(e.key){case"ArrowRight":{var a;const t=z.indexOf(e.currentTarget)+1;n=null!=(a=z[t])?a:z[0];break}case"ArrowLeft":{var o;const t=z.indexOf(e.currentTarget)-1;n=null!=(o=z[t])?o:z[z.length-1];break}}null==(t=n)||t.focus()};return o.createElement("div",{className:(0,l.Z)("tabs-container",p)},o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":u},g)},v.map((e=>{let{value:t,label:n,attributes:r}=e;return o.createElement("li",(0,a.Z)({role:"tab",tabIndex:C===t?0:-1,"aria-selected":C===t,key:t,ref:e=>z.push(e),onKeyDown:S,onFocus:A,onClick:A},r,{className:(0,l.Z)("tabs__item",d,null==r?void 0:r.className,{"tabs__item--active":C===t})}),null!=n?n:t)}))),r?(0,o.cloneElement)(w.filter((e=>e.props.value===C))[0],{className:"margin-top--md"}):o.createElement("div",{className:"margin-top--md"},w.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==C})))))}function m(e){const t=(0,r.Z)();return o.createElement(u,(0,a.Z)({key:String(t)},e))}},1946:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>m,frontMatter:()=>i,metadata:()=>c,toc:()=>d});var a=n(7462),o=(n(7294),n(3905)),l=(n(814),n(5488)),r=n(5162);const i={sidebar_position:1,title:"Protecting one service with network policies",sidebar_label:"Protecting one service with network policies"},s=void 0,c={unversionedId:"guides/protect-1-service-network-policies",id:"guides/protect-1-service-network-policies",title:"Protecting one service with network policies",description:"Otterize enables intent-based access control (IBAC).",source:"@site/docs/guides/protect-1-service-network-policies.mdx",sourceDirName:"guides",slug:"/guides/protect-1-service-network-policies",permalink:"/guides/protect-1-service-network-policies",draft:!1,editUrl:"https://github.com/otterize/docs/edit/main/docs/guides/protect-1-service-network-policies.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"Protecting one service with network policies",sidebar_label:"Protecting one service with network policies"},sidebar:"docSidebar",previous:{title:"IBAC with Istio authorization policies",permalink:"/quick-visual-tutorials/visual-ibac-istio-authorization-policies"},next:{title:"Installation",permalink:"/installation/"}},p={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Seeing the access graph",id:"seeing-the-access-graph",level:2},{value:"Choose one service to protect",id:"choose-one-service-to-protect",level:2},{value:"Declare client intents",id:"declare-client-intents",level:2},{value:"Protect the <code>productcatalogservice</code>",id:"protect-the-productcatalogservice",level:2},{value:"Ready for production",id:"ready-for-production",level:2},{value:"Will load balancers, ingress, and other external traffic be affected?",id:"will-load-balancers-ingress-and-other-external-traffic-be-affected",level:3},{value:"Will admission webhook controllers, e.g. policy validators like Kyverno, be affected?",id:"will-admission-webhook-controllers-eg-policy-validators-like-kyverno-be-affected",level:3},{value:"Working with Otterize in CI/CD",id:"working-with-otterize-in-cicd",level:3},{value:"In summary",id:"in-summary",level:2},{value:"Teardown",id:"teardown",level:2}],u={toc:d};function m(e){let{components:t,...i}=e;return(0,o.kt)("wrapper",(0,a.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Otterize enables intent-based access control (IBAC).\nIn this guide, we'll roll out IBAC gradually, protecting just one service, and taking it all the way to production. We'll show how this can be done quickly, safely, and reproducibly:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Choose one service to protect"),'. Until you ensure its intended clients will have access, you\'ll run in "shadow mode": no network policies will actually be created against this server.'),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Declare all its clients' intents")," to call it ","\u2014"," which may be done automatically using the network mapper. See that it would now allow those clients if protection (using network policies) were turned on."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Turn on protection")," for this one service: it is now secure against unintended access."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"Take it to production")," by understanding how this would also not break other production-relevant access such as ingress and policy management (e.g. Kyverno), and by putting this into your CI/CD process.")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The goal is to show you how to realize zero trust, in production, in a matter of hours or days, even if it's just for one or a few services at first. It is that easy.")),(0,o.kt)("p",null,"This guide uses the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/GoogleCloudPlatform/microservices-demo"},"Google microservices demo"),"\n(a simple e-commerce application), deployed to a Kubernetes cluster, for illustration."),(0,o.kt)("p",null,"Note: all the capabilities of IBAC are within Otterize OSS, while the access graph in Otterize Cloud will guide us visually at each step."),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("details",null,(0,o.kt)("summary",null,"Prepare a cluster"),(0,o.kt)("p",null,"Before you start, you'll need a Kubernetes cluster."),(0,o.kt)("p",null,"Below are instructions for setting up a Kubernetes cluster with network policies.\nIf you don't have a cluster already, we recommend starting out with a Minikube cluster."),(0,o.kt)(l.Z,{groupId:"cni",mdxType:"Tabs"},(0,o.kt)(r.Z,{value:"minikube",label:"Minikube",mdxType:"TabItem"},(0,o.kt)("p",null,"If you don't have the Minikube CLI, first ",(0,o.kt)("a",{parentName:"p",href:"https://minikube.sigs.k8s.io/docs/start/"},"install it"),". "),(0,o.kt)("p",null,"Then start your Minikube cluster with Calico, in order to enforce network policies."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"minikube start --cpus=4 --memory 8192 --disk-size 32g --cni=calico\n")),(0,o.kt)("p",null,"The increased CPU, memory and disk resource allocations are required to be able to deploy the ecommerce app used in the visual tutorials successfully.")),(0,o.kt)(r.Z,{value:"gke",label:"Google GKE",mdxType:"TabItem"},(0,o.kt)("a",{href:"https://cloud.google.com/kubernetes-engine/docs/how-to/network-policy#gcloud"},"Visit the official documentation"),", or follow the instructions below:",(0,o.kt)(l.Z,{mdxType:"Tabs"},(0,o.kt)(r.Z,{value:"cli",label:"gcloud CLI",mdxType:"TabItem"},(0,o.kt)("p",null,"To use the gcloud CLI for this tutorial, first ",(0,o.kt)("a",{parentName:"p",href:"https://cloud.google.com/sdk/docs/install"},"install")," and then\n",(0,o.kt)("a",{parentName:"p",href:"https://cloud.google.com/sdk/docs/initializing"},"initialize")," it."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("em",{parentName:"strong"},"To enable network policy enforcement when creating a new cluster:"))),(0,o.kt)("p",null,"Run the following command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"gcloud container clusters create CLUSTER_NAME --enable-network-policy --zone=ZONE\n")),(0,o.kt)("p",null,"(Replace ",(0,o.kt)("inlineCode",{parentName:"p"},"CLUSTER_NAME")," with the name of the new cluster and ",(0,o.kt)("inlineCode",{parentName:"p"},"ZONE")," with your zone.)"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("em",{parentName:"strong"},"To enable network policy enforcement for an existing cluster, perform the following tasks:"))),(0,o.kt)("p",null,"Run the following command to enable the add-on:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"gcloud container clusters update CLUSTER_NAME --update-addons=NetworkPolicy=ENABLED\n")),(0,o.kt)("p",null,"(Replace ",(0,o.kt)("inlineCode",{parentName:"p"},"CLUSTER_NAME")," with the name of the cluster.)"),(0,o.kt)("p",null,"Then enable network policy enforcement on your cluster, re-creating your cluster's node pools with network policy enforcement enabled:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"gcloud container clusters update CLUSTER_NAME --enable-network-policy\n")),(0,o.kt)("p",null,"(Replace ",(0,o.kt)("inlineCode",{parentName:"p"},"CLUSTER_NAME")," with the name of the cluster.)")),(0,o.kt)(r.Z,{value:"console",label:"Console",mdxType:"TabItem"},(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("em",{parentName:"strong"},"To enable network policy enforcement when creating a new cluster:"))),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Go to the Google Kubernetes Engine page in the Google Cloud console.\nThe remaining steps will appear automatically in the Google Cloud console.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"On the Google Kubernetes Engine page, click Create.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Configure your cluster as desired.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"From the navigation pane, under Cluster, click Networking.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Select the checkbox to Enable network policy.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Click Create."))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("em",{parentName:"strong"},"To enable network policy enforcement for an existing cluster:"))),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Go to the Google Kubernetes Engine page in the Google Cloud console. The remaining steps will appear automatically in the Google Cloud console.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"In the cluster list, click the name of the cluster you want to modify.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Under Networking, in the Network policy field, click Edit network policy.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Select the checkbox to Enable network policy for master and click Save Changes.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Wait for your changes to apply, and then click Edit network policy again.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Select the checkbox to Enable network policy for nodes.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Click Save Changes.")))))),(0,o.kt)(r.Z,{value:"eks",label:"AWS EKS",mdxType:"TabItem"},(0,o.kt)("a",{href:"https://docs.aws.amazon.com/eks/latest/userguide/calico.html"},"Visit the official documentation"),", or follow the instructions below:",(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Spin up an ",(0,o.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html"},"EKS cluster")," using the console, AWS CLI or ",(0,o.kt)("inlineCode",{parentName:"li"},"eksctl"),"."),(0,o.kt)("li",{parentName:"ol"},"Install Calico for network policy enforcement, without replacing the CNI:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.12.6/config/master/calico-operator.yaml\nkubectl apply -f https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.12.6/config/master/calico-crs.yaml\n"))),(0,o.kt)(r.Z,{value:"aks",label:"Azure AKS",mdxType:"TabItem"},(0,o.kt)("p",null,"You can set up an AKS cluster using this ",(0,o.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/aks/learn/quick-kubernetes-deploy-cli"},"guide"),"."),(0,o.kt)("p",null,"For network policy support, no setup is required: Azure AKS comes with a built-in network policy implementation called Azure Network Policy Manager. You can choose whether you'd like to use this option or Calico when you create a cluster."),(0,o.kt)("a",{href:"https://learn.microsoft.com/en-us/azure/aks/use-network-policies"}," Read more at the official documentation site"),"."))),(0,o.kt)("details",null,(0,o.kt)("summary",null,"Deploy the demo set of services"),(0,o.kt)("p",null,"To deploy these into your cluster:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create namespace otterize-ecom-demo\nkubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/ecom-demo.yaml\n"))),(0,o.kt)("details",null,(0,o.kt)("summary",null,"Create an Otterize Cloud account"),(0,o.kt)("p",null,"If you don't already have an account, browse to ",(0,o.kt)("a",{parentName:"p",href:"https://app.otterize.com"},"https://app.otterize.com")," to set one up."),(0,o.kt)("p",null,"If someone in your team has already created an org in Otterize Cloud, and invited you (using your email address), you may see an invitation to accept."),(0,o.kt)("p",null,"Otherwise, you'll create a new org, which you can later rename, and invite your teammates to join you there.")),(0,o.kt)("details",null,(0,o.kt)("summary",null,"Install Otterize OSS"),(0,o.kt)("p",null,'If no Kubernetes clusters are connected to your account, click the "Connect your cluster" button to:'),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create a Cloud cluster object, specifying its name and the name of an environment to which all namespaces in that cluster will belong, by default."),(0,o.kt)("li",{parentName:"ol"},'Connect it with your actual Kubernetes cluster, by clicking on the "Connection guide ',"\u2192","\" link and running the Helm commands shown there. You'll want to use ",(0,o.kt)("inlineCode",{parentName:"li"},"mode=defaultShadow")," so you're in shadow mode on every server until you're ready to protect it.")),(0,o.kt)("details",null,(0,o.kt)("summary",null,"More details, if you're curious"),(0,o.kt)("p",null,"Connecting your cluster simply entails installing Otterize OSS via Helm, using credentials from your account so Otterize OSS can report information needed to visualize the cluster."),(0,o.kt)("p",null,"The credentials will already be inlined into the Helm command shown in the Cloud UI, so you just need to copy that line and run it from your shell.\nIf you don't give it the Cloud credentials, Otterize OSS will run fully standalone in your cluster ","\u2014"," you just won't have the visualization in Otterize Cloud."),(0,o.kt)("p",null,'The Helm command shown in the Cloud UI also includes flags to turn off enforcement: Otterize OSS will be running in "shadow mode," meaning that it will not create network policies to restrict pod-to-pod traffic, or create Kafka ACLs to control access to Kafka topics. Instead, it will report to Otterize Cloud what ',(0,o.kt)("strong",{parentName:"p"},"would")," happen if enforcement were to be enabled, guiding you to implement IBAC without blocking intended access."))),(0,o.kt)("details",null,(0,o.kt)("summary",null,(0,o.kt)("em",null,"Optional: check that the demo was deployed.")),(0,o.kt)("p",null,"To see all the pods in the demo:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get pods -n otterize-ecom-demo\n")),(0,o.kt)("p",null,"The pods should all be ready and running:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"NAME                                     READY   STATUS    RESTARTS      AGE\nadservice-65494cbb9d-5lrv6               1/1     Running   0             115s\ncartservice-6d84fc45bb-hdtwn             1/1     Running   0             115s\ncheckoutservice-5599486df-dvj9n          1/1     Running   3 (79s ago)   115s\ncurrencyservice-6d64686d74-lxb7x         1/1     Running   0             115s\nemailservice-7c6cbfbbd7-xjxlt            1/1     Running   0             115s\nfrontend-f9448d7d4-6dmnr                 1/1     Running   0             115s\nkafka-0                                  1/1     Running   2 (83s ago)   115s\nloadgenerator-7f6987f59-bchgm            1/1     Running   0             114s\norderservice-7ffdbf6df-wzzfd             1/1     Running   0             115s\notterize-ecom-demo-zookeeper-0           1/1     Running   0             115s\npaymentservice-86855d78db-zjjfn          1/1     Running   0             115s\nproductcatalogservice-5944c7f666-2rjc6   1/1     Running   0             115s\nrecommendationservice-6c8d848498-zm2rm   1/1     Running   0             114s\nredis-cart-6b79c5b497-xpms2              1/1     Running   0             115s\nshippingservice-85694cb9bd-v54xp         1/1     Running   0             114s\n")),(0,o.kt)("p",null,"You can now browse the web app of this demo, if you wish:"),(0,o.kt)(l.Z,{groupId:"frontend-addr",mdxType:"Tabs"},(0,o.kt)(r.Z,{value:"k8s",label:"K8s",mdxType:"TabItem"},(0,o.kt)("p",null,"To get the externally-accessible URL where your demo front end is available, run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get service -n otterize-ecom-demo frontend-external | awk '{print $4}'\n")),(0,o.kt)("p",null,"The result should be similar to (if running on AWS EKS):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"a11843075fd254f8099a986467098647-1889474685.us-east-1.elb.amazonaws.com\n")),(0,o.kt)("p",null,'Go ahead and browse to the URL above to "shop" and get a feel for the demo\'s behavior.\n(The URL might take some time to populate across DNS servers. Note that we are accessing an HTTP and not an HTTPS website.)')),(0,o.kt)(r.Z,{value:"minikube",label:"Minikube",mdxType:"TabItem"},(0,o.kt)("p",null,"To get the externally-accessible URL where your demo front end is available, run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kubectl port-forward -n otterize-ecom-demo service/frontend-external 8080:80 &\n")),(0,o.kt)("p",null,"The demo is now accessible at:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"http://localhost:8080\n")),(0,o.kt)("p",null,'Go ahead and browse to the URL above to "shop" and get a feel for the demo\'s behavior.')))),(0,o.kt)("h2",{id:"seeing-the-access-graph"},"Seeing the access graph"),(0,o.kt)("p",null,"In the Otterize Cloud UI, your ",(0,o.kt)("a",{parentName:"p",href:"https://app.otterize.com/clusters"},"cluster")," should now show all 3 Otterize OSS operators ","\u2014"," the network mapper, intents operator, and credentials operator ","\u2014"," as connected, with a green status."),(0,o.kt)("img",{src:"/img/guides/protect-1-service-network-policies/otterize-oss-connected.png",alt:"Access graph - Otterize OSS connected",width:"600"}),(0,o.kt)("p",null,"And when you go back to the ",(0,o.kt)("a",{parentName:"p",href:"https://app.otterize.com/access-graph"},"access graph")," (and select your cluster from the dropdown, if needed), you should see the following map for the demo running in your cluster:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Access graph - network map",src:n(8923).Z,width:"2740",height:"1384"})),(0,o.kt)("p",null,"The graph shows services (nodes) connected by arrows (edges) indicating that one service (acting as a client) called another service (acting as a server). The arrows may be due to calls discovered by the network mapper, or to declared client intents YAMLs, or both."),(0,o.kt)("p",null,"In fact the graph shows a lot of interesting insights, such as:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"For each ",(0,o.kt)("strong",{parentName:"li"},"service")," you can see its namespace and environment. You can also see its state as a server and as a client, if applicable.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"As a ",(0,o.kt)("strong",{parentName:"li"},"server"),", you'll see whether it's ",(0,o.kt)("strong",{parentName:"li"},"protected")," against unauthorized access:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"unprotected"),";"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("span",{style:{color:"#238C32",fontWeight:"bold"}},"protected"),"."))),(0,o.kt)("li",{parentName:"ul"},"As a ",(0,o.kt)("strong",{parentName:"li"},"client"),", you'll see whether it's ",(0,o.kt)("strong",{parentName:"li"},"allowed")," to call its servers:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"would be blocked")," from making some of its calls if the corresponding servers were protected;"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("span",{style:{color:"#238C32",fontWeight:"bold"}},"allowed")," to make all its calls even when all its servers are protected; or"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("span",{style:{color:"#E9615C",fontWeight:"bold"}},"blocked")," now from making some of its calls."))))),(0,o.kt)("li",{parentName:"ul"},"An ",(0,o.kt)("strong",{parentName:"li"},"arrow")," (","\u2192",") indicates an intent by a client to call a server. It's derived from any ",(0,o.kt)("strong",{parentName:"li"},"discovered intent")," ","\u2014"," a call discovered by the network mapper ","\u2014"," and any explicitly ",(0,o.kt)("strong",{parentName:"li"},"declared intent")," that the client declared in its ",(0,o.kt)("inlineCode",{parentName:"li"},"ClientIntents")," YAML.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Its color indicates the blocking status of calls from that client to that server:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"would be blocked")," if the server were protected;"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("span",{style:{color:"#238C32",fontWeight:"bold"}},"allowed")," even when the server is protected; or"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("span",{style:{color:"#E9615C",fontWeight:"bold"}},"blocked")," right now.")))))),(0,o.kt)("p",null,"For our demo, the services and the arrows are all ",(0,o.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"yellow")," because the servers aren't (yet) protected, and because we haven't declared any intents so calls would be blocked if the servers were protected."),(0,o.kt)("p",null,"The graph can reveal more information but this should suffice for the moment."),(0,o.kt)("p",null,"Otterize can configure several access control mechanisms, such as Istio authorization policies and Kafka ACLs, and the access graph can take into account their combined state. But for this demo, we're only using network policies, so let's adjust the access graph view to only take these network policies into account: at the top right, toggle on \"Use in access graph\" for network policies, toggle off for the others."),(0,o.kt)("img",{src:"/img/guides/protect-1-service-network-policies/access-graph-panel.png",alt:"Access graph - access controls panel",width:"800"}),(0,o.kt)("h2",{id:"choose-one-service-to-protect"},"Choose one service to protect"),(0,o.kt)("p",null,"Now let's prepare to protect just one service, but remain in shadow mode: no actual network policies, yet. We'll verify no intended access would be blocked before turning on the network policy protection."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Which service should you protect? That's up to you: maybe you have a particularly sensitive one that's higher priority; maybe you'd rather start with a less important one, until you feel confident."),(0,o.kt)("p",{parentName:"admonition"},"In our case, we'll choose the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),".")),(0,o.kt)("p",null,"Zoom the access graph a bit to enlarge it around the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),":"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Zoom to see productcatalogservice",src:n(842).Z,width:"2374",height:"1636"})),(0,o.kt)("p",null,"Click on the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," to show more details about it:"),(0,o.kt)("img",{src:"/img/guides/protect-1-service-network-policies/productcatalogservice-no-intents.png",alt:"Clicked on productcatalogservice",width:"600"}),(0,o.kt)("p",null,"We can see that:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"As a server, it's currently ",(0,o.kt)("strong",{parentName:"li"},"unprotected")," (specifically, by network policies); that's expected, as we haven't yet turned on protection."),(0,o.kt)("li",{parentName:"ul"},"It ",(0,o.kt)("strong",{parentName:"li"},"would block its clients if it were protected")," (because there would be no network policies allowing their access)."),(0,o.kt)("li",{parentName:"ul"},"To authorize its clients' access, we're told to ",(0,o.kt)("strong",{parentName:"li"},"declare their intents")," (which would generate those network policies ","\u2014"," this is what IBAC means, after all).")),(0,o.kt)("p",null,"Go ahead and close the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," details. It's time to declare its clients' intents."),(0,o.kt)("details",null,(0,o.kt)("summary",null,(0,o.kt)("b",null,"Optional: Understanding intents from the access graph")),(0,o.kt)("p",null,"The access graph shows three services calling the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),": ",(0,o.kt)("inlineCode",{parentName:"p"},"frontend"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"recommendationservice"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"checkoutservice"),'. The access graph shows an arrow between a client and a server if the network mapper discovered calls were happening ("discovered intent"), or if the client explicitly declared an intent to call the server, or both.'),(0,o.kt)("p",null,"Click, for example, on the yellow arrow from ",(0,o.kt)("inlineCode",{parentName:"p"},"frontend")," ","\u2192"," ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),":"),(0,o.kt)("img",{src:"/img/guides/protect-1-service-network-policies/frontend-calls-productcatalogservice-no-intents.png",alt:"Clicked on frontend to productcatalogservice",width:"600"}),(0,o.kt)("p",null,"We see that:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"There is a discovered intent, but without a corresponding declared intent."),(0,o.kt)("li",{parentName:"ul"},"Access would therefore be blocked, once the ",(0,o.kt)("inlineCode",{parentName:"li"},"productcatalogservice")," server is protected."))),(0,o.kt)("h2",{id:"declare-client-intents"},"Declare client intents"),(0,o.kt)("p",null,"The graph visually tells us we';; need to declare all 3 of those clients' intents:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"frontend")," ","\u2192"," ",(0,o.kt)("inlineCode",{parentName:"li"},"productcatalogservice"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"recommendationservice")," ","\u2192"," ",(0,o.kt)("inlineCode",{parentName:"li"},"productcatalogservice"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"checkoutservice")," ","\u2192"," ",(0,o.kt)("inlineCode",{parentName:"li"},"productcatalogservice"),".")),(0,o.kt)("p",null,"But you don't actually have to look at the graph, nor know in advance the way the demo app is supposed to work. You can auto-generate the intents."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"It's likely you'll want the client devs who own the ",(0,o.kt)("inlineCode",{parentName:"p"},"frontend"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"recommendationservice"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"checkoutservice")," to eventually own those intent declarations, evolve them with their client code as their clients' needs change, review and approve them when they do, etc. They can then serve themselves, and make sure they can access the servers they need, while those servers remain protected."),(0,o.kt)("p",{parentName:"admonition"},"But if you're just getting started with IBAC, and want to first see it in production before getting client devs involved, you can just auto-generate the needed client intents. In fact, you don't need to know in advance which clients call the server: the network mapper will tell you all you need. Just make sure there is representative traffic (load) in your cluster so that the network mapper will see all the expected call patterns.")),(0,o.kt)("p",null,"Let's ask the network mapper to export all the client intents it discovered for the clients of ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"otterize network-mapper export --server productcatalogservice.otterize-ecom-demo\n")),(0,o.kt)("p",null,"Here's the output:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: k8s.otterize.com/v1alpha2\nkind: ClientIntents\nmetadata:\n  name: checkoutservice\n  namespace: otterize-ecom-demo\nspec:\n  service:\n    name: checkoutservice\n  calls:\n    - name: cartservice\n    - name: currencyservice\n    - name: emailservice\n    - name: kafka\n    - name: paymentservice\n    - name: productcatalogservice\n    - name: shippingservice\n---\napiVersion: k8s.otterize.com/v1alpha2\nkind: ClientIntents\nmetadata:\n  name: frontend\n  namespace: otterize-ecom-demo\nspec:\n  service:\n    name: frontend\n  calls:\n    - name: adservice\n    - name: cartservice\n    - name: checkoutservice\n    - name: currencyservice\n    - name: productcatalogservice\n    - name: recommendationservice\n    - name: shippingservice\n---\napiVersion: k8s.otterize.com/v1alpha2\nkind: ClientIntents\nmetadata:\n  name: recommendationservice\n  namespace: otterize-ecom-demo\nspec:\n  service:\n    name: recommendationservice\n  calls:\n    - name: productcatalogservice\n")),(0,o.kt)("p",null,"These are indeed the 3 clients of the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),"."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The network mapper detected that these clients will call many servers besides the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice"),", as you would expect by looking at the access graph."),(0,o.kt)("p",{parentName:"admonition"},"Even though we're only looking to protect the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," now, it's ",(0,o.kt)("strong",{parentName:"p"},"best to declare all of those calls")," from those 3 clients: those intents reflect  the actual intent of the code, declaring them won't interfere with anything, and it will get us ready to protect those other servers too, in the future.")),(0,o.kt)("p",null,"Let's apply these client intents:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"otterize network-mapper export --server productcatalogservice.otterize-ecom-demo \\\n| kubectl apply -f -\n")),(0,o.kt)("p",null,"If we now look at the access graph, lo and behold: the lines and arrows from all 3 clients to ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," are now ",(0,o.kt)("strong",{parentName:"p"},"solid")," green: all the necessary intents have been declared. (And a lot of other lines are now green too, since these clients also call many other servers; these other servers may soon be ready to protect too.)"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"3 intents declared",src:n(418).Z,width:"2636",height:"1630"})),(0,o.kt)("p",null,"You can look into at any of the calls to the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," and see they would not be blocked if this server were protected, e.g.:"),(0,o.kt)("img",{src:"/img/guides/protect-1-service-network-policies/frontend-calls-productcatalogservice-with-intents.png",alt:"Clicked on frontend to productcatalogservice",width:"600"}),(0,o.kt)("p",null,"And you can verify the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," would not block ",(0,o.kt)("em",{parentName:"p"},"any")," of its discovered clients by clicking on it:"),(0,o.kt)("img",{src:"/img/guides/protect-1-service-network-policies/productcatalogservice-with-intents.png",alt:"Clicked on productcatalogservice",width:"600"}),(0,o.kt)("p",null,"The server is still ",(0,o.kt)("span",{style:{color:"#F3AF3D",fontWeight:"bold"}},"yellow")," because it's unprotected ","\u2014"," let's fix that."),(0,o.kt)("h2",{id:"protect-the-productcatalogservice"},"Protect the ",(0,o.kt)("inlineCode",{parentName:"h2"},"productcatalogservice")),(0,o.kt)("p",null,"Now that we've verified no intended clients would be blocked, we can safely protect the server."),(0,o.kt)("p",null,"To do so, recall that we configured Otterize OSS to be in the ",(0,o.kt)("inlineCode",{parentName:"p"},"defaultShadow")," mode: by default, it's in shadow mode for all services, not actually managing network policies for them. To protect a service is a simple matter of applying a ",(0,o.kt)("inlineCode",{parentName:"p"},"ProtectedService")," YAML for it, overriding the default for it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: k8s.otterize.com/v1alpha2\nkind: ProtectedService\nmetadata:\n  name: productcatalogservice\n  namespace: otterize-ecom-demo\nspec:\n  name: productcatalogservice\n\n")),(0,o.kt)("p",null,"Let's apply this file to our cluster:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/guides/protect-1-service-network-policies/protect-productcatalogservice.yaml\n")),(0,o.kt)("p",null,"This has two effects:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Applies a default-deny ingress network policy to the ",(0,o.kt)("inlineCode",{parentName:"li"},"productcatalogservice")," to protect it against unauthorized (undeclared) access."),(0,o.kt)("li",{parentName:"ol"},"Creates and manages network policies (including managing labels on client pods, this namespace, and this server pod) for all declared access. In other words, it enforces network policies only ",(0,o.kt)("strong",{parentName:"li"},"for this ",(0,o.kt)("inlineCode",{parentName:"strong"},"productcatalogservice")," server"),".")),(0,o.kt)("p",null,"Let's look again at the access graph to see what happened in the cluster:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"3 intents declared and server protected",src:n(2615).Z,width:"2400",height:"1640"})),(0,o.kt)("p",null,"Sure enough, the ",(0,o.kt)("inlineCode",{parentName:"p"},"productcatalogservice")," is ",(0,o.kt)("span",{style:{color:"#238C32",fontWeight:"bold"}},"green"),": it's ",(0,o.kt)("strong",{parentName:"p"},"protected against unauthorized access"),", and ",(0,o.kt)("strong",{parentName:"p"},"allowing authorized clients")," since its clients' arrows are green. Clicking on it confirms this:"),(0,o.kt)("img",{src:"/img/guides/protect-1-service-network-policies/productcatalogservice-with-intents-protected.png",alt:"Clicked on productcatalogservice",width:"600"}),(0,o.kt)("h2",{id:"ready-for-production"},"Ready for production"),(0,o.kt)("h3",{id:"will-load-balancers-ingress-and-other-external-traffic-be-affected"},"Will load balancers, ingress, and other external traffic be affected?"),(0,o.kt)("p",null,"The intents operator automatically detects resources of kind ",(0,o.kt)("inlineCode",{parentName:"p"},"Service")," (with type ",(0,o.kt)("inlineCode",{parentName:"p"},"LoadBalancer")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"NodePort"),"), or of kind ",(0,o.kt)("inlineCode",{parentName:"p"},"Ingress"),", and creates network policies to allow external traffic to relevant pods."),(0,o.kt)("p",null,"You do not need to configure anything to get this to work. ",(0,o.kt)("a",{parentName:"p",href:"/reference/configuration/intents-operator#handling-external-traffic"},"Learn more here.")),(0,o.kt)("h3",{id:"will-admission-webhook-controllers-eg-policy-validators-like-kyverno-be-affected"},"Will admission webhook controllers, e.g. policy validators like Kyverno, be affected?"),(0,o.kt)("p",null,"Since you are not placing a global default-deny policy that would affect controllers in your cluster, only default-deny network policies on individual pods, Otterize will not affect calls to admission webhook controllers and they will continue functioning as before."),(0,o.kt)("h3",{id:"working-with-otterize-in-cicd"},"Working with Otterize in CI/CD"),(0,o.kt)("p",null,"We recommend placing the ",(0,o.kt)("inlineCode",{parentName:"p"},"ClientIntents")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"ProtectedService")," resource YAMLs alongside the services that own them, in their respective Git repositories:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"ProtectedService")," YAMLs alongside the servers they are protecting, e.g. in the Helm chart belonging to the server."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ClientIntents")," YAMLs, whether they were generated from the network mapper or created and maintained by the client developer teams, alongside each client, e.g. in the Helm chart belonging to the client.")),(0,o.kt)("h2",{id:"in-summary"},"In summary"),(0,o.kt)("p",null,"So what have we learned? You can gradually roll out IBAC and drive towards zero trust, service by service, in a safe, predictable, and quick way, by following 4 simple steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Choose a service to protect, say ",(0,o.kt)("inlineCode",{parentName:"li"},"<NAME>.<NAMESPACE>"),"."),(0,o.kt)("li",{parentName:"ol"},"Export its client's intents: ",(0,o.kt)("inlineCode",{parentName:"li"},"otterize network-mapper export --server <NAME>.<NAMESPACE> > protect-<NAME>.yaml"),"."),(0,o.kt)("li",{parentName:"ol"},"Declare those intents: ",(0,o.kt)("inlineCode",{parentName:"li"},"kubectl apply -f protect-<NAME>.yaml"),"."),(0,o.kt)("li",{parentName:"ol"},"Now protect that server by ",(0,o.kt)("inlineCode",{parentName:"li"},"kubectl apply -f")," with the following YAML:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: k8s.otterize.com/v1alpha2\nkind: ProtectedService\nmetadata:\n  name: <NAME>\n  namespace: <NAMESPACE>\nspec:\n  name: <NAME>\n")),(0,o.kt)("p",null,"Lather, rinse repeat, protecting service after service as you grow more comfortable, with the access graph providing visibility at each step of the way."),(0,o.kt)("h2",{id:"teardown"},"Teardown"),(0,o.kt)("p",null,"To remove the deployed demo run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl delete -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/all.yaml\nkubectl delete -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/shadow-mode/ecom-demo.yaml\nkubectl delete namespace otterize-ecom-demo\n")))}m.isMDXComponent=!0},2615:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/3-intents-protected-db8a9446622faf1d2caad15ad9c848a0.png"},418:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/3-intents-unprotected-7d5bdc12ca63c2e3e1e0a72f797c1ce7.png"},842:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/enlarged-no-intents-974acdea68bb1942a356a31fd094e618.png"},8923:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/network-map-bb511853f7bf07084bd1e40ff0523b18.png"}}]);