---
sidebar_position: 9
title: Kubernetes mTLS with Otterize
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Otterize can automatically provision mTLS credentials by baking existing K8s workload identities into certificates.

<!-- FIXME
:::note to complete
:::
-->

## Mounting mTLS credentials into pods
To generate credentials for the pod we simply need to update the deployment by annotating it.
The required steps are to
1. Annotate the pod - Otterize automatically identifies the `otterize/tls-secret-name` annotation, generates
mTLS credentials, and stores them as K8s secret named as the annotation value.
2. Mount the credentials stored as a K8s secret as a volume
3. Mount the volume into the container

<details>
<summary>Expand to see a detailed explanation for the annotations</summary>

```yaml
spec:
  template:
    metadata:
      ...
      annotations:
        # 1 Generate credentials
        # highlight-next-line
        otterize/tls-secret-name: client-credentials-secret
    spec:
      volumes:
        # highlight-start
        - name: otterize-credentials
          secret:
            # 2 Mount credentials as a volume
            secretName: client-credentials-secret
            # highlight-end
      containers:
        - name: client
        ...
        volumeMounts:
          # highlight-start
          - name: otterize-credentials
            # 3 Mount volume into container
            mountPath: /var/otterize/credentials
            readOnly: true
            # highlight-end
```
</details>

### Annotation parameters
For the complete list of annotation parameters please follow the SPIRE integration operator
[documentation](/components/spire-integration-operator/).

- `spire-integration.otterize.com/tls-secret-name`  - The name of the k8s secret in which the certificate data is stored
- `spire-integration.otterize.com/dns-names` - A comma-separated list of additional dns names to be registered as part of the certificate's SAN (Subject Alternative Name) extension.
- `spire-integration.otterize.com/cert-ttl` - The certificate TTL. Defaults to SPIRE-server's configured default TTL

:::note
Otterize defaults to generating credentials with an expiry time of 1 day. The certificates are
automatically refreshed before expiring, and you must take care to always read the credentials from file, rather than caching them for this reason.

To set a longer expiration time, set the `spire-integration.otterize.com/cert-ttl` annotation for your pods. For more information, see the documentation for the [SPIRE Integration Operator](/components/spire-integration-operator)
:::

:::tip
Certificates are automatically refreshed before expiring. We recommend loading certificates each time before using them where possible.
:::

## Using mTLS credentials

### HTTP

#### Client

<Tabs>
<TabItem value="js" label="JavaScript" default>

```js
{@include: ../../static/code-examples/code/mtls/http/client.js}
```
</TabItem>
<TabItem value="go" label="Go">

```go
{@include: ../../static/code-examples/code/mtls/http/client.go}
```
</TabItem>
<TabItem value="python" label="Python">

```python
{@include: ../../static/code-examples/code/mtls/http/client.py}
```
</TabItem>
<TabItem value="curl" label="cURL">

```shell
{@include: ../../static/code-examples/code/mtls/http/client.sh}
```
</TabItem>
</Tabs>

#### Server

<Tabs>
<TabItem value="js" label="JavaScript" default>

```js
{@include: ../../static/code-examples/code/mtls/http/server.js}
```
</TabItem>
<TabItem value="go" label="Go">

```go
{@include: ../../static/code-examples/code/mtls/http/server.go}
```
</TabItem>
<TabItem value="python" label="Python">

```python
{@include: ../../static/code-examples/code/mtls/http/server.py}
```
</TabItem>
</Tabs>

### Kafka
<Tabs>
<TabItem value="js" label="JavaScript" default>

```python
{@include: ../../static/code-examples/code/mtls/kafka/client.js}
```
</TabItem>
<TabItem value="go" label="Go">

```python
{@include: ../../static/code-examples/code/mtls/kafka/client.go}
```
</TabItem>
<TabItem value="python" label="Python">

```python
{@include: ../../static/code-examples/code/mtls/kafka/client.py}
```
</TabItem>
<TabItem value="bash" label="Bash" default>
You can use Kafka's builtin kafka-console-consumer.sh script to connect to Kafka. The script requires the credentials
to be generated in the JKS format.
<Tabs>
<TabItem value="bash" label="Bash" default>

```bash
{@include: ../../static/code-examples/code/mtls/kafka/client.sh}
```
</TabItem>
<TabItem value="client.properties" label="client.properties">

```properties
{@include: ../../static/code-examples/code/mtls/kafka/client.properties}
```
</TabItem>
</Tabs>
</TabItem>
</Tabs>

## Verify generated credentials

We can use openssl to inspect the generated certificates. The certificates are stored as `K8s secrets` and are also
`mounted` into containers.

We will first retrieve them with one of the following options

   <Tabs>
     <TabItem value="secret-direct" label="K8s secret" default>
   To retrieve the credentials from the K8s secrets store use:

   ```shell
   kubectl get secret -n otterize-tutorial-mtls client-credentials-secret -o jsonpath='{.data.svid\.pem}' | base64 -d > svid.pem
   ```
   </TabItem>
   <TabItem value="secret-pod" label="K8s pod mount" default>
   To retrieve the credentials from the container mount use:

   ```shell
   kubectl exec -n otterize-tutorial-mtls -it deploy/client -- cat /var/otterize/credentials/svid.pem > svid.pem
   ```

   </TabItem>
   </Tabs>

And then inspect them with

   ```shell
   openssl x509 -in svid.pem -text | head -n 15
   ```
   You should see a similar output to
   ```x509
   Certificate:
       Data:
           Version: 3 (0x2)
           Serial Number:
               0b:eb:eb:4d:0e:02:7e:28:93:30:1c:55:26:22:8b:c7
           Signature Algorithm: sha256WithRSAEncryption
           Issuer: C = US, O = SPIRE
           Validity
               Not Before: Aug 24 12:19:57 2022 GMT
               Not After : Sep 23 12:20:07 2022 GMT
   # highlight-next-line
           Subject: C = US, O = SPIRE, CN = client.otterize-tutorial-mtls       # the client's name
           Subject Public Key Info:
               Public Key Algorithm: id-ecPublicKey
                   Public-Key: (256 bit)
                   pub:
   ```

You can see that Otterize generated an X.509 keypair using the pod's name `client` and namespace `otterize-tutorial-mtls`: `client.otterize-tutorial-mtls`.
The certificate belongs to a chain of trust starting at the SPIRE server.


#### What happened behind the scenes

1. We annotated the pods to let Otterize know it should generate mTLS credentials.
2. The Otterize SPIRE integration operator
    1. Created an entries for the annotated pods with the SPIRE server.
    2. Generated matching mTLS credentials using the SPIRE server.
    3. Stored the mTLS credentials into a K8s secrets.
3. The secrets were mounted (separately) into each pod's container.
4. The pods communicated with each other over HTTP using mutual TLS.

## What's next

- Learn how to configure your existing code to use mTLS for [HTTPS](/service-identities/using-credentials/#http)
(clients and servers) and for [Kafka clients](/service-identities/using-credentials/#kafka).
- Configure secure access between pods and Kafka with this [guide](/guides/ibac-for-k8s-kafka/).
