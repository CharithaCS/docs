---
title: Mapping pod-to-pod calls in Kubernetes
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

The network mapper allows you to map pod-to-pod traffic within your K8s cluster. This tutorial will guide you
through installing Otterize, mapping traffic and tracking changes.

## Install the network mapper

{@include: ../../_common/install-otterize-network-mapper.md}

## Install the Otterize CLI

{@include: ../../_common/install-otterize-cli.md}


## Retrieving the network map

### Choose a Kubernetes cluster and services

You can use this guide with your own set of services, e.g. first in a Kubernetes cluster running dev or lab services,
and eventually in a staging or production cluster.

Alternatively, you can start with services from our reference lab,
which is based on the [Google microservices demo](https://github.com/GoogleCloudPlatform/microservices-demo)
simulating an e-commerce application. You'll deploy these into any Kubernetes cluster to which you have admin access.

For the sake of illustration, we'll refer to the reference lab example in this guide. But if you're using
your own services, just apply the same steps and adjust the particulars to your needs.

### Reference lab example

The reference e-commerce application architecture is as follows
![Demo e-commerce](https://github.com/GoogleCloudPlatform/microservices-demo/raw/main/docs/img/architecture-diagram.png)

### Deploying the reference lab

Create a namespace to hold the services, and deploy them:
```bash
kubectl create namespace otterize-ecom-demo
kubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/microservices-demo/kubernetes-manifests.yml
```
<details>
<summary>Optional: check that the lab was deployed...</summary>
<div>


    To see all the pods in the lab:
    ```bash
    kubectl get pods -n otterize-ecom-demo
    ```
    The pods should all be ready and running:
    ```bash
    NAME                                     READY   STATUS    RESTARTS   AGE
    adservice-694f4ff98-cz4nn                1/1     Running   0          23m
    cartservice-85f8bc44fd-45cbk             1/1     Running   0          23m
    checkoutservice-8fc47bbbd-9lhfv          1/1     Running   0          23m
    currencyservice-597bdf576b-8hftc         1/1     Running   0          23m
    emailservice-d5c6f74dd-qlwc4             1/1     Running   0          23m
    frontend-7ffbf49884-j9rhz                1/1     Running   0          23m
    loadgenerator-65779994db-tgdxk           1/1     Running   0          23m
    paymentservice-76b9c8b87d-ktfcd          1/1     Running   0          23m
    productcatalogservice-6969d4f5fd-xdw99   1/1     Running   0          23m
    recommendationservice-58798d5c8-2f4rz    1/1     Running   0          23m
    redis-cart-6f65887b5d-xwpz5              1/1     Running   0          23m
    shippingservice-ff5f4d7d-qcjw8           1/1     Running   0          23m
    ```


</div>
</details>

{@include: ../../_common/network-mapper/intents-list-export-demo-lab.md}


### Filtering by namespace
You can query the mapper for calls originating only from a specific namespace with:
```bash
otterize mapper list -n <namespace>
```

### Resetting the current network map
The Otterize network mapper keeps track of active connections as long as it's running. You can clear its state by running:
```bash
otterize mapper reset
```

:::tip
For the complete list of the Otterize network mapper capabilities
read the [CLI command reference](/cli/#network-mapper).
:::

## Track network map changes over time

Using a few simple command-line tricks, you can track changes to the network map over time.

1. Let's save the current state of traffic from the cluster into a file we will compare against later
   ```shell
   otterize mapper list -n otterize-ecom-demo > intents-original.txt
   ```

2. And now we can add traffic to the cluster and see how the network mapper tracks it. You can do that by deploying our
   example
   which consists of a single pod: testing-service, communicating over HTTP with the frontend. Deploy example:
   ```shell
   kubectl apply -n otterize-ecom-demo -f https://docs.otterize.com/code-examples/network-mapper/testing-service-to-frontend-deployment.yaml
   ```

<details>
<summary>Check that the new pod was deployed</summary>

```bash
    kubectl get pods -n otterize-ecom-demo -l app=testing-service
```
You should see
```
NAME                               READY   STATUS    RESTARTS   AGE
testing-service-7b8cc77c67-9ksk8   1/1     Running   0          3m3s
```
</details>

3. Export the updated observed intents.
   ```shell
   otterize mapper list -n otterize-ecom-demo
   ```
   You will now see the testing-service and frontend pods communication in addition
   to the previously observed traffic.
   ```shell
   cartservice in namespace otterize-ecom-demo calls:
     - redis-cart
   checkoutservice in namespace otterize-ecom-demo calls:
     - cartservice
     - currencyservice
     - emailservice
     - paymentservice
     - productcatalogservice
     - shippingservice
   frontend in namespace otterize-ecom-demo calls:
     - adservice
     - cartservice
     - checkoutservice
     - currencyservice
     - productcatalogservice
     - recommendationservice
     - shippingservice
   loadgenerator in namespace otterize-ecom-demo calls:
     - frontend
   recommendationservice in namespace otterize-ecom-demo calls:
     - productcatalogservice
   # highlight-start
   testing-service in namespace otterize-ecom-demo calls:
     - frontend
   # highlight-end
   ```
5. We can also compare both outputs to see the difference. We'll start by saving the updated state to a file with:
   ```bash
   otterize mapper list -n otterize-ecom-demo > intents-updated.txt
   ```
6. And compare the original file with the updated file using:
   ```bash
   diff --color=always -y intents-original.txt intents-updated.txt;echo
   ```
   You should see similar output:
   ```bash
   cartservice in namespace otterize-ecom-demo calls:              cartservice in namespace otterize-ecom-demo calls:
     - redis-cart                                                    - redis-cart
   checkoutservice in namespace otterize-ecom-demo calls:          checkoutservice in namespace otterize-ecom-demo calls:
     - cartservice                                                   - cartservice
     - currencyservice                                               - currencyservice
     - emailservice                                                  - emailservice
     - paymentservice                                                - paymentservice
     - productcatalogservice                                         - productcatalogservice
     - shippingservice                                               - shippingservice
   frontend in namespace otterize-ecom-demo calls:                 frontend in namespace otterize-ecom-demo calls:
     - adservice                                                     - adservice
     - cartservice                                                   - cartservice
     - checkoutservice                                               - checkoutservice
     - currencyservice                                               - currencyservice
     - productcatalogservice                                         - productcatalogservice
     - recommendationservice                                         - recommendationservice
     - shippingservice                                               - shippingservice
   loadgenerator in namespace otterize-ecom-demo calls:            loadgenerator in namespace otterize-ecom-demo calls:
     - frontend                                                      - frontend
   recommendationservice in namespace otterize-ecom-demo calls:    recommendationservice in namespace otterize-ecom-demo calls:
     - productcatalogservice                                         - productcatalogservice
                                                                 > testing-service in namespace otterize-ecom-demo calls:
                                                                 >   - frontend
    ```


## Which calls are picked up
The Otterize network mapper creates a map of in-cluster traffic by (1) capturing DNS traffic and (2) inspecting active connections in the same manner `netstat` does, then resolving the IP addresses participating in connections to the Pods, and crawling up the ownership of the Pod until it reaches the root object.

To learn more, read about the [network mapper](/components/network-mapper).

<!-- FIXME
:::tip
Checkout this blog by Evyatar Meged about how we implemented this feature.
:::
-->

## Network mapping for bootstrapping access controls
To export intents from the Otterize network mapper, run:
```bash
otterize mapper export
```
The output is concatenated ClientIntents which can be piped to `kubectl apply`.
```yaml
apiVersion: k8s.otterize.com/v1alpha1
kind: ClientIntents
metadata:
  name: frontend
  namespace: otterize-ecom-demo
spec:
  service:
    name: frontend
  calls:
    - name: checkoutservice
      type: HTTP
---
apiVersion: k8s.otterize.com/v1alpha1
kind: ClientIntents
metadata:
  name: checkoutservice
  namespace: otterize-ecom-demo
spec:
  service:
    name: checkoutservice
  calls:
    - name: productcatalogservice
      type: HTTP
```

You can directly apply these ClientIntents to K8s and Otterize will enforce network policies according to them automatically.
:::tip
To learn more about how to use ClientIntents to manage network policies read this [guide](/guides/k8s-ibac-via-network-policies/)
:::

## What's next

- Use your mapped traffic as intents and implement [IBAC via network policies](/guides/k8s-ibac-via-network-policies/).


## Design note

* The network mapper is designed for situations where pods use Kubernetes DNS for service discovery.

### Teardown

To remove the deployed resources run:

```bash
kubectl delete namespace otterize-ecom-demo
```