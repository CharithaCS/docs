---
sidebar_position: 3
title: Deploy mTLS between pods and Kafka
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Kafka + mTLS

This tutorial will walk you through deploying mTLS certificates between a client and a Kafka cluster.
We will:

- Install Otterize
- Learn how to configure bitnami's kafka chart to use Otterize-provided mTLS credentials
- Deploy a Kafka cluster
- Learn how to annotate pods for automatic credentials generation
- Deploy a client connecting to Kafka with mTLS
- Inspect the credentials

## Install Otterize
{@include: ../_common/install-otterize.md}

## Install Kafka

We will deploy a Kafka cluster using bitnami's [chart](https://github.com/bitnami/charts/tree/master/bitnami/kafka)
To configure the chart to use the Otterize-provided credentials we need to configure it to:

1. Use SSL for it's listeners
2. Tell Otterize using pod annotations how it requires it's credentials
3. Authenticate using mTLS credentials provided as a K8s secret


<details>
<summary>Expand to see the configuration details...</summary>

```yaml
# 1. Use SSL for it's listeners
listeners:
  - "CLIENT://:9092"
  - "INTERNAL://:9093"
advertisedListeners:
  - "CLIENT://:9092"
  - "INTERNAL://:9093"
listenerSecurityProtocolMap: "INTERNAL:SSL,CLIENT:SSL"
# 2. Annotations for Otterize to generate credentials
podAnnotations:
  spire-integration.otterize.com/cert-type: jks
  spire-integration.otterize.com/tls-secret-name: kafka-tls-secret
  spire-integration.otterize.com/truststore-file-name: kafka.truststore.jks
  spire-integration.otterize.com/keystore-file-name: kafka-keystore.jks
  spire-integration.otterize.com/dns-names: "kafka-0.kafka-headless.kafka.svc.cluster.local,kafka.kafka.svc.cluster.local"
# 3. Authenticate clients using mTLS
auth:
  clientProtocol: mtls
  interBrokerProtocol: mtls
  tls:
    type: jks
    existingSecrets:
      - kafka-tls-secret
    password: password
authorizerClassName: kafka.security.authorizer.AclAuthorizer
```
</details>

The following command will deploy a Kafka cluster configured to use Otterize-provided mTLS credentials.

 ```bash
 helm repo add bitnami https://charts.bitnami.com/bitnami
 helm upgrade --install --create-namespace -n kafka kafka \
 --version 14.x.x bitnami/kafka \
 -f https://docs.otterize.com/code-examples/kafka-mtls/helm/values.yaml
 ```

<details>
<summary>Optional: check deployment status</summary>
<div>

It can take several minutes for the pods to **stabilize** into the `Ready` and `Running` states. You can monitor with
the following command:

 ```bash
kubectl get pods -n kafka -w
 ```

After **stabilization** you should see:

 ```bash
 NAME                READY   STATUS    RESTARTS      AGE
kafka-0             1/1     Running   1 (25s ago)   45s
kafka-zookeeper-0   1/1     Running   0             56s
 ```
</div>
</details>


## Deploy
To generate credentials for the pod we simply need to update the deployment by annotating it.
The required steps are to
1. Annotate the pod - Otterize automatically identifies the `otterize/credentials-secret-name` annotation, generates
mTLS credentials, and stores them as K8s secret named as the annotation value.
2. Mount the credentials stored as a K8s secret as a volume
3. Mount the volume into the container

<details>
<summary>Expand to see a detailed explanation for the annotations</summary>

```yaml
spec:
  template:
    metadata:
      ...
      annotations:
        # highlight-next-line
        otterize/credentials-secret-name: client-credentials-secret       # 1 Generate credentials
    spec:
      volumes:
        # highlight-start
        - name: otterize-credentials
          secret:
            secretName: client-credentials-secret                         # 2 Mount credentials as a volume
            # highlight-end
      containers:
        - name: client
        ...
        volumeMounts:
          # highlight-start
          - name: otterize-credentials
            mountPath: /var/otterize/credentials                          # 3 Mount volume into container
            readOnly: true
            # highlight-end
```
</details>

Our simple example consists of single client pod and a Kafka.

<details>
<summary>Expand to see the details of this example...</summary>
<Tabs>

<TabItem value="namespace.yaml" label="namespace.yaml" default>

   ```yaml
   {@include: ../../../static/code-examples/kafka-mtls/namespace.yaml}
   ```

</TabItem>

<TabItem value="client-deployment.yaml" label="client-deployment.yaml">

   ```yaml
  {@include: ../../../static/code-examples/kafka-mtls/client-deployment.yaml}
  ```

</TabItem>

<TabItem value="client-configmap.yaml" label="client-configmap.yaml">

   ```yaml
  {@include: ../../../static/code-examples/kafka-mtls/client-configmap.yaml}
  ```

</TabItem>

</Tabs>
</details>


1. Let's deploy a client connecting to Kafka
    ```bash
    kubectl apply -f https://docs.otterize.com/code-examples/kafka-mtls/all.yaml
    ```
2. Check that the `client` `pod` was deployed
   ```bash
   kubectl get pods -n otterize-tutorial-kafka-mtls
   ```
   You should see
   ```
   NAME                     READY   STATUS    RESTARTS   AGE
   client-dcff84688-4b2xm   1/1     Running   0          32s
   ```

:::note
Client logs require improvement. Client is compiling on startup so it can take some time before it's ready.
Need to solve this.
:::

3. Check that the client succesfully connected to Kafka using mTLS
    ```bash
    kubectl logs --tail=1 -n otterize-tutorial-kafka-mtls deploy/client -f
    ```
   You should get
    ```bash
    Loading mTLS certificates
    Connecting to Kafka
    Creating a producer and a consumer
    Sending messages
    Sent message - Message 1
    Sent message - Message 2
    Sent message - Message 3
    Sent message - Message 4
    Sent message - Message 5
    Read message - Message 1
    Read message - Message 2
    Read message - Message 3
    Read message - Message 4
    Read message - Message 5
    ```

## What happened behind the scenes

3. We configured the Kafka helm chart to
    1. Use the SSL protocol for its listeners
    2. Annotated its pod to let Otterize know it should generate mTLS credentials in the Java Key Store and Java Trust
       Store format and store them as a K8s secret.
    3. Use the K8s secret for mTLS by configuring Kafka's auth mechanism.
4. We annotated the client pod to let Otterize know it should generate mTLS credentials in a PEM format.
5. The Otterize SPIRE integration operator
    1. For each of [Kafka, client]
        1. Created an entries for the annotated pods with the SPIRE server.
        2. Generated matching mTLS credentials using the SPIRE server.
        3. Stored the mTLS credentials into a K8s secrets.
6. The secrets were mounted (separately) into each pod's container.
7. The client pod connected and authenticated to Kafka using mTLS.

:::info
Visit the [Behavior](/documentation/credential-operator/behavior) section to view all parameters available as pod
annotation for generating mTLS credentials.
:::

## Teardown

To remove the deployed resources run

```bash
kubectl delete -f https://docs.otterize.com/code-examples/kafka-mtls/all.yaml
helm uninstall -n kafka kafka
helm repo remove bitnami
```